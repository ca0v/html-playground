<html>

<head>
    <style>
        body {
            background-color: black;
            color: white;
        }

        grid {
            display: grid;
            grid-template-columns: repeat(1, 20em);
        }

        grid-item {
            transition: all 100ms linear;
            opacity: 1;
        }

        .slide-out {
            transform: translate(50%, 0);
            opacity: 0;
        }

        .slide-in {
            transform: translate(-50%, 0);
            opacity: 0.5;
        }

        .start-update {
            transform: translate(-2px, 0);
            opacity: 0.8;
        }

        .source-items,
        .source-items-3 {
            display: none;
        }
    </style>
</head>

<body>
    <h2>This is the target grid</h2>
    <grid class="target">
        <grid-item>Hello From Grid</grid-item>
    </grid>
    <grid class="source-items source-items-0">
    </grid>
    <grid class="source-items source-items-1">
    </grid>
    <grid class="source-items source-items-2">
    </grid>
    <grid class="source-items-3">
        <grid-item>Goodbye Grid</grid-item>
    </grid>
</body>

<script>

    (function () {
        function range(count) {
            const result = new Array(count);
            result.fill(count);
            return result.map((v, i) => i);
        }

        function randomInt(range = 1000) {
            return Math.floor(range * Math.random());
        }

        function randomCompassDir() {
            const list = "N S W E NW NE SW SE".split(" ");
            return list[randomInt(list.length)];
        }

        function randomStreetName() {
            const list = "MAIN PLEASANT MOUNTAIN PINNACLE SUMMIT RAMPART".split(" ");
            return list[randomInt(list.length)];
        }

        function randomStreetSuffix() {
            const list = "ST AVE WAY COURT BLVD".split(" ");
            return list[randomInt(list.length)];
        }

        function randomAddress() {
            return `${randomCompassDir()} ${randomStreetName()}`;
        }

        Array.from(document.body.querySelectorAll("grid.source-items")).forEach(grid => {
            console.log("populating grid");
            let values = range(5 + randomInt(50))
                .map(i => randomAddress());

            values = [...new Set(values)];

            values
                .forEach(text => {
                    const item = document.createElement("grid-item");
                    item.innerText = text;
                    grid.appendChild(item);
                });
        });
    })();


    /**
     * Add animations to show old items being deleted (slide out to right)
     * and new items being inserted (slide in from left)
     * and modified items being updated (fade out/in)
     */
    (function () {

        const ANIMATION_DELAY = 200;

        const slideIn = (node) => {
            node.classList.add("slide-in");
            setTimeout(() => node.classList.remove("slide-in"), ANIMATION_DELAY);
        }

        const slideOut = (node) => {
            node.classList.add("slide-out");
            setTimeout(() => node.remove(), ANIMATION_DELAY);
        }

        const replaceNode = (source, target) => {
            target.classList.add("start-update");
            setTimeout(() => {
                target.innerText = source.innerText;
                target.classList.remove("start-update");
            }, ANIMATION_DELAY);
        };

        const hash = domNode => {
            return domNode.innerText;
        };

        const collect = selector => {
            return Array.from(document.body.querySelectorAll(selector));
        }

        const computeDiff = (set1, set2) => {
            // set1 - set2
            const set1Only = [];
            const set2Only = [];

            set1.forEach((item1, index) => {
                if (-1 === set2.indexOf(item1)) set1Only.push(index);
            });
            set2.forEach((item2, index) => {
                if (-1 === set1.indexOf(item2)) set2Only.push(index);
            });
            return [set1Only, set2Only];
        }

        const insertNode = (sibling, node) => {
            sibling.parentElement.insertBefore(node, null);
        };

        const applyDiffInfo = (diffInfo, set1, set2) => {
            // are we deleting or inserting?
            const sourceDiff = diffInfo[0];
            const targetDiff = diffInfo[1];
            const mergeUpper = Math.min(sourceDiff.length, targetDiff.length);
            const inserting = sourceDiff.length > targetDiff.length;
            const deleting = sourceDiff.length < targetDiff.length;
            console.log("updating", mergeUpper);

            for (let i = 0; i < mergeUpper; i++) {
                replaceNode(set1[sourceDiff[i]], set2[targetDiff[i]]);
            }

            if (inserting) {
                console.log("inserting", sourceDiff.length - mergeUpper);
                for (let i = mergeUpper; i < sourceDiff.length; i++) {
                    const clone = set1[sourceDiff[i]].cloneNode(true);
                    slideIn(clone);
                    insertNode(set2[targetDiff[0]], clone);
                }
            }

            if (deleting) {
                console.log("deleting", targetDiff.length - mergeUpper);
                for (let i = mergeUpper; i < targetDiff.length; i++) {
                    console.log("removing", i);
                    slideOut(set2[targetDiff[i]]);
                }
            }
        };

        [0, 1, 2, 1, 0, 1, 2, 3, 0, 1, 2, 1, 0, 1, 2, 3, 0, 1, 2, 1, 0, 1, 2, 3, 0, 1, 2, 1, 0, 1, 2, 3].forEach((sourceItem, timeOffset) => {
            setTimeout(() => {
                const sourceItems = collect(`grid.source-items-${sourceItem} grid-item`);
                const targetItems = collect("grid.target grid-item");
                const diffInfo = computeDiff(sourceItems.map(hash), targetItems.map(hash));
                console.log(diffInfo);
                applyDiffInfo(diffInfo, sourceItems, targetItems);
            }, 1000 + 1000 * timeOffset);

        })
    })();

</script>

</html>